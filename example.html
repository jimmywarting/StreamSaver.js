<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>example.com</title>
	</head>
	<body>
		<h1>Example of saving a stream directly to the filesystem</h1>
		<form id="$form">
			<h3>What would you like to save?</h3>
			<label><input name="kind" value="text" type="radio" checked>Plain text (Save as you type)</label><br>
			<label><input name="kind" value="video" type="radio">Video stream</label><br>
			<label><input name="kind" value="audio" type="radio">Audio stream</label><br>
			<!-- disabled until now, haven't had the time to write any demo using fetch -->
			<label><input disabled name="kind" value="fetch" type="radio">Fetch stream</label>
			 - kind of cheesy, since you can use fetchEvent to add
			 Content-Disposition header (but requires service worker + ssl)<br>
			<label><input name="kind" value="screen" type="radio">Screen stream</label>
			- requires chromes <a href="https://goo.gl/5La0Iz">Screen Capturing</a> extension<br><br>
			<label>What should the name of the file be?<br>
				<input name="$filename" required value="sample.txt">
			</label>
			<input type="submit" value="Start">
		</form>
		<div id="$writer" hidden>
			<button id="$a">Write some aaa's</button>
			<button id="$b">Write some bbb's</button>
			<button id="$c">Write some ccc's</button>
		</div>
		<button id="$close" hidden>close stream</button>
		<script src="https://rawgit.com/jimmywarting/browser-su/master/build/permissions.js"></script>
		<script src="StreamSaver.js"></script>
		<script>
			$form.onsubmit = event => {
				event.preventDefault()

				let
				kind = $form.querySelector(':checked').value,
				filename = $form.$filename.value,
				permission

				$form.remove()

				switch (kind) {
					case "text":
						$writer.hidden = false
						/*
						let stream = new ReadableStream({
							start(controller) {
								$a.onclick = $b.onclick = $c.onclick = event => {
									let data = event.target.id[1].repeat(1024)
									let uint8array = encoder.encode(data + "\n\n")
									controller.enqueue(uint8array)
								}
							},
							cancel() {
								console.log("user aborted")
							}
						})

						// TODO: This is what we should be doing...
						saveStream(null, filename)
						*/
						let encoder = new TextEncoder
						let unofficialApi = saveStream(null, filename)

						// You don't need the popup any more if you write atleast
						// 1024 bytes has been transferred
						if(unofficialApi._usePopup) {
							setTimeout(()=>{
								let data = "a".repeat(1024)
								let uint8array = encoder.encode(data + "\n\n")
								unofficialApi._write(uint8array)
							}, 1000)
						}

						$a.onclick = $b.onclick = $c.onclick = event => {
							let data = event.target.id[1].repeat(1024)
							let uint8array = encoder.encode(data + "\n\n")
							unofficialApi._write(uint8array)
							$close.hidden = false
						}
						// it should close automaticly when the stream ends...
						$close.onclick = unofficialApi._close
					break; case "video":
						permission = {name: 'userMedia', video: true}
					break; case "audio":
						permission = {name: 'userMedia', audio: true}
					break; case "fetch":
						let url = "http://d8d913s460fub.cloudfront.net/videoserver/cat-test-video-320x240.mp4"
						fetch(url).then(res => {
							// https://jakearchibald.com/2016/streams-ftw/
						})
					break; case "screen":
						permission = {name: 'screen'}
					break;
				}



				permission && su.request(permission).then(stream => {
					// Haven't decided yet on the api
					let unofficialApi = saveStream(stream, filename)
					$close.hidden = false
					// it should close automaticly when the stream ends...
					$close.onclick = unofficialApi._close
				})
			}
		</script>
	</body>
</html>
